Serial Console Setup on Linux
=============================

This has been verified on CentOS 7, but the general principles and
many specifics are the same on most Linux systems.

Be careful if you automate this setup (e.g., with Ansible) on a
physical host as it can be a pain to recover from a misconfigured
console.


### Reconfiguring Grub

At boot [Grub] reads its configuration (including the menu items to
display) from `/boot/grub2/grub.cfg`. However, this file is normally
never edited directly bug is generated by running

    grub2-mkconfig -o /boot/grub2/grub.cfg

As described in the [Simple Configuration][sc] section of the Grub
documentation, this will read `/etc/default/grub` and other system
information (such as the disk partitions and the currently installed
kernels) to generate a new Grub configuration. Serial console
configuration for both Grub and the kernel(s) is done in the
`/etc/default/grub` file.

[Grub]: https://www.gnu.org/software/grub/manual/grub.html
[sc]: https://www.gnu.org/software/grub/manual/grub.html#Simple-configuration


### Grub Console

Grub itself can display output simultaneously on as many different
devices as you care to configure. Some configurations (such as this
one tested on CentOS 7) will also accept input from all devices
simultaneously. However, in other cases Grub may accept further input
only from the first device from which it recieves a keystroke.

In `/etc/default/grub` set [`GRUB_TERMINAL`][sc] to include all your
console devices in any order:

    GRUB_TERMINAL='console serial'

Note that `GRUB_TERMINAL` should override both `GRUB_TERMINAL_INPUT`
and `GRUB_TERMINAL_OUTPUT`, but to be safe and avoid confusion, you
should delete these variables if they are present.

##### Serial Port Speed

On virtual machines the serial port speed is typically left at the
default of 9600; the VM doesn't actually slow down the output to this
rate. On physical machines however, the speed must match what's on the
other end, which is the [IPMI management unit][IPMI] on most modern
servers. Use the IPMI setup program or BIOS setup to set a reasonably
high speed (typically 57,600 or 115,200 bps) and in
`/etc/default/grub` add a [serial] command:

    GRUB_SERIAL_COMMAND="serial --speed=57600"

[serial]: https://www.gnu.org/software/grub/manual/grub.html#Serial-terminal
[IPMI]: https://en.wikipedia.org/wiki/Intelligent_Platform_Management_Interface


### Linux Kernel

`GRUB_CMDLINE_LINUX` in `/etc/default/grub` contains command line
parameters used when starting the kernel.

We can pass in multiple `console=DEVICE` parameters, where `DEVICE` is
`console`, `serial` or one of several other parameters described in
the Grub documentation. The kernel will print console messages on all
devices specified. However, this applies only to messages generated by
the kernel itself; I/O to the `/dev/console` device seen by userland
will go only to the device specified in the _last_ `console=`
parameter. A typical command line would include:

    GRUB_CMDLINE_LINUX=... console=/dev/tty0 console=/dev/ttyS0

`systemd` will generally start a `getty` process (to give a login
prompt) on all devices listed as consoles on the Linux kernel command
line.
